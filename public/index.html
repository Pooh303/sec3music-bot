<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sec 3 Music Player</title>
    <link rel="icon" type="image/png" href="images/music.png">

    <!-- Google Fonts - Noto Sans Thai and Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&family=Sarabun:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet"> 
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        :root {
            --discord-dark: #36393f;
            --discord-darker: #2f3136;
            --discord-darkest: #202225;
            --discord-accent: #7289da;
            --discord-text: #ffffff;
            --discord-text-muted: #b9bbbe;
            --font-main: "Sarabun", "Noto Sans Thai", sans-serif; 
        }
        body { 
            padding: 20px; 
            background-color: var(--discord-dark); 
            color: var(--discord-text); 
            min-height: 100vh; 
            font-family: var(--font-main); 
            font-weight: 400; 
        }
        h1, h5, .btn, .form-control, 
        .song-info strong, .song-info span, 
        .added-by span, 
        #userInfoDisplay span strong, #userInfoDisplay span, 
        .queue-header strong, 
        .search-result-item .title, .search-result-item .channel, 
        .no-songs, .loading-spinner,
        .queue-item .song-info
         {
            font-family: var(--font-main);
        }
        .container { max-width: 800px; }
        .card { background-color: var(--discord-darker); border: none; margin-top: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 8px; }
        .card-body { padding: 1.5rem; }
        .form-control { background-color: var(--discord-darkest); border: 1px solid transparent; color: var(--discord-text); padding: 0.75rem 1rem; border-radius: 4px; line-height: 1.6; font-size: smaller;}
        .form-control::placeholder { color: var(--discord-text-muted); opacity: 1; font-weight: 300; }
        .form-control:focus { background-color: var(--discord-darkest); color: var(--discord-text); box-shadow: none; border-color: var(--discord-accent); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 4px; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background-color: var(--discord-accent); border: none; }
        .btn-primary:hover { background-color: #677bc4; } 
        .btn i { margin-right: 8px; }
        .seek-controls { display: flex; justify-content: center; align-items: center; margin-top: 0.75rem; gap: 1rem; }
        .seek-btn { background-color: transparent; border: 1px solid var(--discord-text-muted); color: var(--discord-text-muted); padding: 0.3rem 0.6rem; font-size: 0.9em; border-radius: 20px; }
        .seek-btn:hover { background-color: var(--discord-darkest); color: var(--discord-text); }
        .seek-btn i { margin-right: 5px; }
        .queue-item { padding: 1rem; border-bottom: 1px solid var(--discord-darkest); transition: background-color 0.2s ease; color: var(--discord-text); display: flex; justify-content: space-between; align-items: center; position: relative; border-radius: 12px; }
        .queue-item:hover { background-color: var(--discord-darkest); }
        .queue-item-list {border-radius: 12px; margin-top: 4px;} 
        .queue-header { padding: 1.2rem; color: var(--discord-text); display: flex; justify-content: space-between; align-items: center; font-weight: 600; margin-bottom: -12px;} 
        .queue-item:last-child { border-bottom: none; }
        .queue-item .delete-btn { color: var(--discord-text-muted); background: none; border: none; padding: 5px; cursor: pointer; transition: all 0.2s ease; opacity: 0.5; }
        .queue-item:hover .delete-btn { opacity: 1; }
        .queue-item .delete-btn:hover { color: #ff4444; transform: scale(1.1); }
        .queue-item .song-info { flex: 1; margin-right: 10px; font-weight: 500; } 
        .current-song .song-info strong { font-weight: 700; color: #ffc107;} 
        .current-song .song-info > span[style*="font-weight: 500"] { font-weight: 500 !important; } 
        .current-song { background-color: var(--discord-darkest); border-left: 30px solid var(--discord-accent); } 
        .volume-control { display: flex; align-items: center; gap: 1rem; }
        .volume-control i { color: var(--discord-text-muted); cursor: pointer; }
        .form-range::-webkit-slider-thumb { background: var(--discord-accent); }
        .form-range::-moz-range-thumb { background: var(--discord-accent); }
        .form-range::-ms-thumb { background: var(--discord-accent); }
        .queue-item .song-duration { color: var(--discord-text-muted); font-size: 0.875rem; font-weight: 300; }
        .current-song .song-duration { display: inline-block; margin-right: 10px; }
        .queue-item .countdown { color: var(--discord-accent); font-weight: 700; } 
        .controls { display: flex; gap: 1rem; justify-content: center; margin: 1.5rem 0; }
        .queue-title { color: var(--discord-text); font-size: 1.1rem; margin-bottom: 1rem; padding: 0 1rem; font-weight: 600; }
        .no-songs { text-align: center; color: var(--discord-text-muted); padding: 2rem; font-weight: 300; }
        .search-results { background-color: var(--discord-darkest); border-radius: 4px; margin-top: 10px; max-height: 400px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--discord-accent) var(--discord-darkest); }
        .search-results::-webkit-scrollbar { width: 8px; }
        .search-results::-webkit-scrollbar-track { background: var(--discord-darkest); border-radius: 4px; }
        .search-results::-webkit-scrollbar-thumb { background: var(--discord-accent); border-radius: 4px; }
        .search-results::-webkit-scrollbar-thumb:hover { background: #677bc4; }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--discord-dark); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--discord-darker); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--discord-accent); }
        .search-result-item { padding: 10px; border-bottom: 1px solid var(--discord-darker); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .search-result-item:hover { background-color: var(--discord-dark); } 
        .search-result-item img { width: 120px; height: 68px; object-fit: cover; border-radius: 4px; }
        .search-result-item .info { flex: 1; }
        .search-result-item .title { color: var(--discord-text); margin-bottom: 4px; font-weight: 500; }
        .search-result-item .channel { color: var(--discord-text-muted); font-size: 0.9em; font-weight: 300; }
        .loading-spinner { text-align: center; padding: 20px; color: var(--discord-text-muted); font-weight: 300; }
        .search-result-item.selected { background-color: var(--discord-accent); }
        .search-result-item.selected .title, .search-result-item.selected .channel { color: white; }
        .disk-container { width: 250px; height: 250px; margin: 20px auto; display: flex; justify-content: center; align-items: center; }
        .vinyl-disk { width: 100%; height: 100%; background-color: #222; border-radius: 50%; position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.5), inset 0 0 10px rgba(0,0,0,0.7), inset 0 0 50px rgba(50,50,50,0.3); display: flex; justify-content: center; align-items: center; overflow: hidden; animation: rotateDisk 10s linear infinite; animation-play-state: paused; }
        .vinyl-disk.playing { animation-play-state: running; }
        .disk-label { width: 65%; height: 65%; border-radius: 50%; object-fit: cover; border: 3px solid #111; box-shadow: 0 0 5px rgba(255,255,255,0.1); pointer-events: none; }
        @keyframes rotateDisk { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .video-player-card-title { color: var(--discord-text); font-size: 1.1rem; margin-bottom: 1rem; text-align: center; font-weight: 600; }
        .added-by { display: block; font-size: 0.8em; color: var(--discord-text-muted); margin-top: 5px; line-height: 16px; font-weight: 300; }
        .added-by-avatar { width: 20px; height: 20px; border-radius: 50%; margin-right: 5px; vertical-align: middle;} 
        #userInfoDisplay { text-align: center; margin-bottom: 15px; padding: 10px 15px; background-color: var(--discord-darkest); border-radius: 8px; transition: background-image 0.5s ease-in-out, box-shadow 0.3s ease; }
        #userInfoDisplay.session-active { background-size: 200% 200%; background-image: linear-gradient( 45deg, #2c3e50, #3498db, #8e44ad, #e74c3c ); animation: gradientAnimation 10s ease infinite; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        #userInfoDisplay img { width: 32px; height: 32px; border-radius: 50%; vertical-align: middle; margin-right: 8px; } 
        #userInfoDisplay small { color: #ffc107; font-weight: 300; }
        #userInfoDisplay.session-active span{ color: var(--discord-text); text-shadow: 0 0 3px rgba(0,0,0,0.5);; }
        #userInfoDisplay.session-active span strong { color: lightgreen; text-shadow: 0 0 3px rgba(0,0,0,0.5);; }
        #userInfoDisplay span { vertical-align: middle; font-weight: 500; }
        #userInfoDisplay span strong { font-weight: 700; }        
        #userInfoDisplay .close-session-message-btn { margin-left: 15px; cursor: pointer; font-weight: bold; padding: 0 5px; text-decoration: none; font-size: 1.2em; line-height: 1; vertical-align: baseline; }
        #userInfoDisplay .close-session-message-btn { color: var(--discord-text-muted); }
        #userInfoDisplay .close-session-message-btn:hover { color: var(--discord-text); }
        #userInfoDisplay.session-active .close-session-message-btn { color: rgba(255, 255, 255, 0.8); text-shadow: 0 0 2px rgba(0,0,0,0.5); }
        #userInfoDisplay.session-active .close-session-message-btn:hover { color: #ffffff; }
        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .hidden-for-unsessioned { display: none !important; }
        .swal2-popup { background: var(--discord-darker) !important; color: var(--discord-text) !important; border-radius: 8px !important; font-family: var(--font-main) !important; }
        .swal2-title { color: var(--discord-text) !important; font-family: var(--font-main) !important; font-weight: 600 !important; }
        .swal2-html-container, .swal2-html-container p, .swal2-html-container div { color: var(--discord-text-muted) !important; font-family: var(--font-main) !important; font-weight: 400 !important; }
        .swal2-confirm { background-color: var(--discord-accent) !important; border-radius: 4px !important; font-family: var(--font-main) !important; font-weight: 500 !important; border: none !important; box-shadow: none !important; }
        .swal2-confirm:hover { background-color: #677bc4 !important; }
        .swal2-icon.swal2-error { border-color: #dc3545 !important; color: #dc3545 !important; }
        .swal2-icon.swal2-success .swal2-success-ring { border-color: #28a745 !important; }
        .swal2-icon.swal2-success .swal2-success-line-tip, .swal2-icon.swal2-success .swal2-success-line-long { background-color: #28a745 !important; }
        .swal2-icon.swal2-warning { border-color: #ffc107 !important; color: #ffc107 !important; }
        .swal2-icon.swal2-info { border-color: var(--discord-accent) !important; color: var(--discord-accent) !important; }
        .swal2-timer-progress-bar { background: var(--discord-accent) !important; }
        .queue-item-list.sortable-ghost { opacity: 0.4; background: var(--discord-darkest); }
        .drag-handle { cursor: grab; margin-right: 10px; color: var(--discord-text-muted); padding: 0 5px; }
        .drag-handle:hover { color: var(--discord-accent); }
        #onlineUsersContainer { display: none; justify-content: center; align-items: center; gap: 5px; margin-bottom: 15px; margin-top: 15px; padding: 8px; background-color: var(--discord-darkest); border-radius: 25px; min-height: 50px; transition: all 0.3s ease; flex-wrap: wrap; }
        .online-user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--discord-accent); object-fit: cover; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2); user-select: none; }
        .online-user-avatar:hover { transform: scale(1.1); z-index: 10; }
        .overflow-avatar { background-color: var(--discord-darkest); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9em; color: var(--discord-text-muted); }
        
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: var(--discord-dark);
            border-radius: 4px;
            margin: 10px 0 5px 0;
            cursor: pointer;
            overflow: hidden;
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--discord-accent);
            border-radius: 4px;
            transition: width 0.2s linear;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center m-2" style="font-weight: 600;"><i class="fas fa-compact-disc"></i> Sec 3 Music ®</h1>
        
        <div class="container-vid" id="videoPlayerCard" style="display: none;"> 
            <div class="card-body">
                <div class="disk-container">
                    <div class="vinyl-disk" id="vinylDisk">
                        <img id="youtubeThumbnail" src="" alt="Song cover" class="disk-label">
                    </div>
                </div>
            </div>
        </div>
        
        <div id="onlineUsersContainer"></div>

        <div class="card hidden-for-unsessioned" id="controlsCard"> 
            <div class="card-body">
                <form id="playForm" class="mb-2">
                    <div class="input-group">
                        <input type="text" id="urlInput" class="form-control" placeholder="Search YouTube or paste URL" required autocomplete="off">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-play"></i> Play</button>
                    </div>
                </form>
                <div id="searchResults" class="search-results" style="display: none;"></div>
                <div class="controls">
                    <button id="skipBtn" class="btn btn-primary"><i class="fas fa-forward"></i> Skip</button>
                    <button id="pauseBtn" class="btn btn-primary" style="display: none;"><i class="fas fa-pause"></i> Pause</button> 
                    <button id="resumeBtn" class="btn btn-primary" style="display: none;"><i class="fas fa-play"></i> Resume</button>
                    <button id="stopBtn" class="btn btn-primary"><i class="fas fa-stop"></i> Stop</button>
                </div>
                <div class="volume-control">
                    <i class="fas fa-volume-up" id="volumeIcon" title="Mute/Unmute"></i> 
                    <input type="range" class="form-range" id="volumeSlider" min="0" max="200" value="100">
                </div>
            </div>
        </div>
        
        <div id="userInfoDisplayContainer"></div>

        <div class="card"> 
            <div class="card-body">
                <h5 class="queue-title" style="font-weight: 600;"><i class="fas fa-list"></i> Queue</h5>
                <div id="nowPlayingContainer"></div>
                <div id="queueItemsContainer"></div>
                <div id="emptyQueueMessage" class="no-songs" style="display: none; font-weight: 300;">
                    <i class="fas fa-info-circle"></i> Queue is empty.
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const API_URL = ''; 
        const SESSION_STORAGE_KEY = 'musicPlayerSessionToken'; 
        const MAX_VISIBLE_AVATARS = 15;

        let onlineUsersList = [];
        let searchTimeout = null;
        let selectedResultIndex = -1;
        let searchResultsData = [];
        let currentUser = null;
        let isMuted = false;
        let previousVolumeBeforeMute = 100; 
        let currentSongDataForSeek = null; 
        let sortableQueue = null; 
        let socket = null;
        let songProgressInterval = null;

        const urlInput = document.getElementById('urlInput');
        const searchResultsDiv = document.getElementById('searchResults');
        const playForm = document.getElementById('playForm');
        const skipBtn = document.getElementById('skipBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeIcon = document.getElementById('volumeIcon'); 
        const nowPlayingContainer = document.getElementById('nowPlayingContainer');
        const queueItemsContainer = document.getElementById('queueItemsContainer'); 
        const emptyQueueMessage = document.getElementById('emptyQueueMessage');
        const videoPlayerCard = document.getElementById('videoPlayerCard');
        const youtubeThumbnail = document.getElementById('youtubeThumbnail');
        const vinylDisk = document.getElementById('vinylDisk');
        const userInfoDisplayContainer = document.getElementById('userInfoDisplayContainer'); 
        const controlsCard = document.getElementById('controlsCard'); 
        const onlineUsersContainer = document.getElementById('onlineUsersContainer');

        function showNotification(type, title, text = '') {
            Swal.fire({
                icon: type, 
                title: title,
                text: text,
                toast: true, 
                position: 'top-end', 
                showConfirmButton: false, 
                timer: 3000, 
                timerProgressBar: true, 
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
        }

        function clearAndHideSearchResults() {
            searchResultsDiv.style.display = 'none';
            searchResultsDiv.innerHTML = '';
            searchResultsData = [];
            selectedResultIndex = -1;
        }

        function updateOnlineUsersDisplay() {
            onlineUsersContainer.innerHTML = '';
            onlineUsersList.slice(0, MAX_VISIBLE_AVATARS).forEach(user => {
                const avatarImg = document.createElement('img');
                avatarImg.src = user.userAvatar;
                avatarImg.title = user.userName;
                avatarImg.className = 'online-user-avatar';
                avatarImg.draggable = false;
                onlineUsersContainer.appendChild(avatarImg);
            });
            if (onlineUsersList.length > MAX_VISIBLE_AVATARS) {
                const overflowEl = document.createElement('div');
                overflowEl.className = 'online-user-avatar overflow-avatar';
                overflowEl.textContent = `+${onlineUsersList.length - MAX_VISIBLE_AVATARS}`;
                onlineUsersContainer.appendChild(overflowEl);
            }
            onlineUsersContainer.style.display = onlineUsersList.length > 0 ? 'flex' : 'none';
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            searchResultsDiv.addEventListener('click', (event) => {
                const searchItem = event.target.closest('.search-result-item');
                if (searchItem && searchItem.dataset.videoId) playVideo(searchItem.dataset.videoId);
            });

            const userInfoDisplay = document.createElement('div');
            userInfoDisplay.id = 'userInfoDisplay'; 
            userInfoDisplayContainer.appendChild(userInfoDisplay);

            const urlParams = new URLSearchParams(window.location.search);
            let sessionTokenFromUrl = urlParams.get('session_token');
            if (sessionTokenFromUrl) { 
                localStorage.setItem(SESSION_STORAGE_KEY, sessionTokenFromUrl);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            let activeToken = localStorage.getItem(SESSION_STORAGE_KEY);
            let initialErrorMessage = null; 

            socket = io();
            socket.on('queue-updated', processQueueData);
            socket.on('current-users', (users) => { onlineUsersList = users; updateOnlineUsersDisplay(); });
            socket.on('user-left', (userId) => {
                const userWhoLeft = onlineUsersList.find(u => u.userId === userId);
                if (userWhoLeft) {
                    showNotification('warning', `${userWhoLeft.userName} left.`);
                    onlineUsersList = onlineUsersList.filter(u => u.userId !== userId);
                    updateOnlineUsersDisplay();
                }
            });
            
            if (activeToken) {
                try {
                    const response = await fetch(`${API_URL}/api/user-info?token=${activeToken}`);
                    if (response.ok) {
                        currentUser = await response.json();
                        socket.on('connect', () => { if (activeToken) socket.emit('identify', activeToken); });
                        if (socket.connected) socket.emit('identify', activeToken);
                        socket.on('user-joined', (user) => {
                            if (currentUser && user.userId !== currentUser.userId) showNotification('info', `${user.userName} joined the party!`);
                            if (!onlineUsersList.some(u => u.userId === user.userId)) {
                                onlineUsersList.push(user);
                                updateOnlineUsersDisplay();
                            }
                        });
                    } else {
                        initialErrorMessage = `Session Error: ${(await response.json()).error}. Please use <code>!music</code> again.`;
                        localStorage.removeItem(SESSION_STORAGE_KEY); 
                    }
                } catch (error) {
                    initialErrorMessage = 'Error verifying session. Please use <code>!music</code> again.';
                    localStorage.removeItem(SESSION_STORAGE_KEY); 
                }
            } else {
                initialErrorMessage = 'No active session. Use the <code>!music</code> command in Discord to get a link.';
            }
            
            displayUserInfo(currentUser, initialErrorMessage);
            fetchInitialQueue();

            urlInput.addEventListener('keydown', handleSearchKeyDown);
            urlInput.addEventListener('input', handleSearchInput);
            playForm.addEventListener('submit', handlePlayFormSubmit);
            skipBtn.addEventListener('click', handleSkip);
            pauseBtn.addEventListener('click', handlePause);
            resumeBtn.addEventListener('click', handleResume);
            stopBtn.addEventListener('click', handleStop);
            volumeSlider.addEventListener('input', handleVolumeChange); 
            volumeIcon.addEventListener('click', toggleMute); 
            document.addEventListener('click', (e) => {
                if (!playForm.contains(e.target) && !searchResultsDiv.contains(e.target)) {
                    clearAndHideSearchResults();
                }
            });
        });

        async function fetchInitialQueue() {
            try {
                const response = await fetch(`${API_URL}/api/queue`);
                if (response.ok) processQueueData(await response.json());
            } catch (error) { console.error('Error fetching initial queue:', error); }
        }
        
        function processQueueData(data) {
            const hasCurrentSong = !!data.current;
            const isActuallyPlaying = hasCurrentSong && !data.current.paused;

            if (currentUser) { 
                pauseBtn.style.display = isActuallyPlaying ? 'inline-block' : 'none';
                resumeBtn.style.display = hasCurrentSong && data.current.paused ? 'inline-block' : 'none';
            }
            
            updateNowPlayingDisplay(data.current);
            updateQueueItemsDisplay(data.queue);
            
            const isQueueEmpty = !hasCurrentSong && (!data.queue || data.queue.length === 0);
            emptyQueueMessage.style.display = isQueueEmpty ? 'block' : 'none';
            if (isQueueEmpty) {
                 if (queueItemsContainer) queueItemsContainer.innerHTML = ''; 
                 if (sortableQueue) { sortableQueue.destroy(); sortableQueue = null; }
            } else {
                 emptyQueueMessage.style.display = 'none';
            }
        }

        function displayUserInfo(userData, errorMessage = null) {
            const userInfoDisplay = document.getElementById('userInfoDisplay'); 
            const sessionValid = userData && !errorMessage;
            let messageHtml = '';

            if (errorMessage && (!userData || !sessionValid)) { 
                messageHtml = `<small style="font-weight: 300;">${errorMessage}<span class="close-session-message-btn" title="Hide message" onclick="this.parentElement.parentElement.style.display='none'">×</span></small>`;
                userInfoDisplay.classList.remove('session-active'); 
            } else if (userData) { 
                messageHtml = `<img src="${userData.userAvatar}" alt="${userData.userName}"><span>Interacting as: <strong>${userData.userName}</strong></span>`;
                userInfoDisplay.classList.add('session-active'); 
            } else { 
                messageHtml = `<small style="font-weight: 300;">No active session. Use <code>!music</code> command in Discord.<span class="close-session-message-btn" title="Hide message" onclick="this.parentElement.parentElement.style.display='none'">×</span></small>`;
                userInfoDisplay.classList.remove('session-active'); 
            }

            userInfoDisplay.innerHTML = messageHtml;
            userInfoDisplay.style.display = 'block'; 
            controlsCard.classList.toggle('hidden-for-unsessioned', !sessionValid);
        }

        function getYouTubeVideoId(url) { 
            if (!url || typeof url !== 'string') return null;
            const match = url.match(/(?:v=|embed\/|v\/|shorts\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            return (match && match[1]) ? match[1] : null;
        }
        
        async function handleSearchKeyDown(e) { 
            if(!currentUser) return; 
            if (e.key === 'Enter') { 
                e.preventDefault(); 
                if (selectedResultIndex > -1 && searchResultsData[selectedResultIndex]) {
                    playVideo(searchResultsData[selectedResultIndex].id.videoId);
                } else {
                    playForm.requestSubmit();
                }
            } else if (searchResultsDiv.style.display !== 'none' && searchResultsData.length > 0) { 
                if (e.key === 'ArrowDown') { e.preventDefault(); selectedResultIndex = Math.min(selectedResultIndex + 1, searchResultsData.length - 1); }
                else if (e.key === 'ArrowUp') { e.preventDefault(); selectedResultIndex = Math.max(selectedResultIndex - 1, 0); } 
                updateSelectedResultVisuals();
            }
        }

        function updateSelectedResultVisuals() { 
            Array.from(searchResultsDiv.children).forEach((item, idx) => item.classList.toggle('selected', idx === selectedResultIndex));
            if (selectedResultIndex > -1 && searchResultsDiv.children[selectedResultIndex]) { 
                 searchResultsDiv.children[selectedResultIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        async function performSearch(query) {
            try {
                const response = await fetch(`${API_URL}/api/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error((await response.json()).error || 'Search failed');
                return (await response.json()).items || [];
            } catch (error) { 
                showNotification('error', 'Search Error', error.message); 
                return []; 
            } 
        }

        function handleSearchInput(e) { 
            if(!currentUser) return; 
            const query = e.target.value.trim(); 
            selectedResultIndex = -1;
            if (searchTimeout) clearTimeout(searchTimeout);
            if (!query || isValidUrl(query)) { clearAndHideSearchResults(); return; }
            searchResultsDiv.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Searching...</div>`;
            searchResultsDiv.style.display = 'block';
            searchTimeout = setTimeout(async () => {
                searchResultsData = await performSearch(query); 
                if (searchResultsData.length > 0) {
                    searchResultsDiv.innerHTML = searchResultsData.map(item => `
                        <div class="search-result-item" data-video-id="${item.id.videoId}">
                            <img src="${item.snippet.thumbnails.medium.url}" alt="${item.snippet.title}">
                            <div class="info">
                                <div class="title">${item.snippet.title}</div>
                                <div class="channel">${item.snippet.channelTitle}</div>
                            </div>
                        </div>`).join('');
                } else { 
                    searchResultsDiv.innerHTML = `<div class="loading-spinner">No results found</div>`; 
                }
            }, 500);
        }

        async function playVideo(videoId, directUrl = null) { 
            if (!currentUser) { showNotification('warning', 'No Session', 'Please use !music in Discord.'); return; }
            const urlToPlay = directUrl || `https://www.youtube.com/watch?v=${videoId}`;
            urlInput.value = ''; 
            clearAndHideSearchResults();
            showNotification('info', 'กำลังเพิ่มเพลง...', 'รอสักครู่นะ เดี๋ยวเพลงก็มา!');
            try { await handleApiAction('/play', 'POST', { url: urlToPlay, userId: currentUser.userId }); } 
            catch (error) { /* handleApiAction shows error */ }
        }

        async function handlePlayFormSubmit(e) { 
            e.preventDefault(); 
            if (!currentUser) return;
            const queryOrUrl = urlInput.value.trim(); 
            if (!queryOrUrl) return;
            clearAndHideSearchResults();
            if (isValidUrl(queryOrUrl)) { 
                await playVideo(null, queryOrUrl); 
            } else { 
                showNotification('info', 'กำลังค้นหา...', `ค้นหาเพลง "${queryOrUrl}"`);
                const searchData = await performSearch(queryOrUrl); 
                if (searchData && searchData.length > 0) await playVideo(searchData[0].id.videoId);
                else showNotification('info', 'ไม่เจอเพลง', `ไม่พบผลลัพธ์สำหรับ "${queryOrUrl}"`);
            }
        }

        function isValidUrl(string) { try { new URL(string); return true; } catch (_) { return false; } }

        async function handleApiAction(endpoint, method = 'POST', body = null) {
            try {
                const options = { method, headers: { 'Content-Type': 'application/json' }, body: body ? JSON.stringify(body) : null };
                const response = await fetch(`${API_URL}/api${endpoint}`, options);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'API action failed');
                if(data.message && !['/volume', '/seek', '/reorder-queue'].includes(endpoint)) showNotification('success', 'สำเร็จ!', data.message);
            } catch (error) { 
                showNotification('error', 'เกิดข้อผิดพลาด', error.message); 
                throw error; 
            }
        }

        function handleSkip() { if(!currentUser) return; handleApiAction('/skip'); }
        function handlePause() { if(!currentUser) return; handleApiAction('/pause'); } 
        function handleResume() { if(!currentUser) return; handleApiAction('/resume'); } 
        function handleStop() { if(!currentUser) return; handleApiAction('/stop'); } 
        
        async function handleVolumeChange(e) { 
            if(!currentUser) return;
            const newVolume = parseInt(e.target.value);
            isMuted = newVolume === 0;
            updateVolumeIconDOM(newVolume);
            try {
                await handleApiAction('/volume', 'POST', { volume: newVolume });
                if (!isMuted && newVolume > 0) previousVolumeBeforeMute = newVolume;
            } catch (error) { /* handled */ }
        }

        function updateVolumeIconDOM(volume) { 
            volumeIcon.className = 'fas';
            if (volume === 0 || isMuted) volumeIcon.classList.add('fa-volume-mute');
            else if (volume <= 30) volumeIcon.classList.add('fa-volume-off');
            else if (volume <= 70) volumeIcon.classList.add('fa-volume-down');
            else volumeIcon.classList.add('fa-volume-up');
        }

        async function toggleMute() { 
            if(!currentUser) return; 
            isMuted = !isMuted;
            const targetVolume = isMuted ? 0 : (previousVolumeBeforeMute > 0 ? previousVolumeBeforeMute : 50);
            volumeSlider.value = targetVolume; 
            updateVolumeIconDOM(targetVolume); 
            try { await handleApiAction('/volume', 'POST', { volume: targetVolume }); } 
            catch (error) { /* handled */ }
        }

        async function handleSeek(seconds) {
            if (!currentUser || !currentSongDataForSeek || currentSongDataForSeek.isLive) return;
            const newTime = currentSongDataForSeek.currentTime + seconds;
            try { await handleApiAction('/seek', 'POST', { time: Math.max(0, newTime) }); } 
            catch (error) { fetchInitialQueue(); }
        }
        
        function updateNowPlayingDisplay(currentSongData) {
            if (songProgressInterval) clearInterval(songProgressInterval);
            currentSongDataForSeek = currentSongData;

            if (!nowPlayingContainer || !currentSongData) {
                nowPlayingContainer.innerHTML = '';
                if (videoPlayerCard) videoPlayerCard.style.display = 'none';
                if (vinylDisk) vinylDisk.classList.remove('playing');
                return;
            }

            const addedBy = currentSongData.metadata?.addedBy;
            const isActuallyPlaying = !currentSongData.paused;

            if (videoPlayerCard && youtubeThumbnail && vinylDisk) {
                const videoId = getYouTubeVideoId(currentSongData.url);
                if (videoId) {
                    youtubeThumbnail.src = `https://img.youtube.com/vi/${videoId}/sddefault.jpg`;
                    youtubeThumbnail.alt = (currentSongData.name || "Song cover") + " label";
                    youtubeThumbnail.onerror = () => { youtubeThumbnail.src = 'https://via.placeholder.com/250/202225/FFFFFF?text=No+Cover'; };
                    videoPlayerCard.style.display = 'block';
                } else { 
                    videoPlayerCard.style.display = 'none';
                }
                vinylDisk.classList.toggle('playing', isActuallyPlaying);
            }
            
            let localCurrentTime = currentSongData.currentTime;
            
            const progressBarHtml = !currentSongData.isLive && currentUser ? `<div class="progress-container" id="progressContainer"><div class="progress-bar" id="progressBar"></div></div>` : '';
            const seekControlsHtml = currentUser && !currentSongData.isLive ? `<div class="seek-controls"><button class="btn seek-btn" onclick="handleSeek(-10)" title="Rewind 10s"><i class="fas fa-backward"></i> 10s</button><button class="btn seek-btn" onclick="handleSeek(10)" title="Forward 10s">10s <i class="fas fa-forward"></i></button></div>` : '';
            const addedByHtml = addedBy ? `<small class="added-by"><img src="${addedBy.avatar || ''}" class="added-by-avatar" alt="${addedBy.name || ''}"><span style="font-weight: 300;">${addedBy.name || 'Unknown'}</span></small>` : '';
            
            nowPlayingContainer.innerHTML = `
                <div class="queue-item current-song current-song-item" data-song-id="${currentSongData.id}">
                    <div class="song-info">
                        <strong style="font-weight: 700;">Now Playing:</strong> <span style="font-weight: 500;">${currentSongData.name}</span>
                        <div>
                            <span class="song-duration"><i class="fas fa-clock"></i> <span class="song-time-display">${formatDuration(localCurrentTime)} / ${currentSongData.isLive ? 'LIVE' : formatDuration(currentSongData.duration)}</span></span>
                            <span class="countdown song-countdown-display">(${currentSongData.isLive ? 'LIVE' : formatDuration(currentSongData.duration - localCurrentTime) + ' left'})</span>
                        </div>
                        ${progressBarHtml}
                        ${addedByHtml}
                        ${seekControlsHtml}
                    </div>
                </div>
            `;
            
            const progressBarElement = document.getElementById('progressBar');
            if (progressBarElement && currentSongData.duration > 0) {
                progressBarElement.style.width = `${(localCurrentTime / currentSongData.duration) * 100}%`;
            }

            if (isActuallyPlaying && !currentSongData.isLive) {
                const timeDisplay = nowPlayingContainer.querySelector('.song-time-display');
                const countdownDisplay = nowPlayingContainer.querySelector('.song-countdown-display');
                
                songProgressInterval = setInterval(() => {
                    localCurrentTime++;
                    if (currentSongData.duration > 0 && localCurrentTime > currentSongData.duration) localCurrentTime = currentSongData.duration;
                    if (timeDisplay) timeDisplay.textContent = `${formatDuration(localCurrentTime)} / ${formatDuration(currentSongData.duration)}`;
                    if (countdownDisplay) countdownDisplay.textContent = `(${formatDuration(currentSongData.duration - localCurrentTime)} left)`;
                    if (progressBarElement && currentSongData.duration > 0) progressBarElement.style.width = `${(localCurrentTime / currentSongData.duration) * 100}%`;
                }, 1000);
            }

            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                progressContainer.addEventListener('click', handleProgressBarSeek);
            }
        }
        
        function handleProgressBarSeek(e) {
            if (!currentUser || !currentSongDataForSeek || currentSongDataForSeek.isLive || currentSongDataForSeek.duration <= 0) return;
            const seekTime = (e.offsetX / e.currentTarget.offsetWidth) * currentSongDataForSeek.duration;
            handleApiAction('/seek', 'POST', { time: Math.floor(seekTime) });
        }

        function updateQueueItemsDisplay(queueData) { 
            if (!queueItemsContainer) return; 
            if (!queueData || queueData.length === 0) {
                queueItemsContainer.innerHTML = ''; 
                if (sortableQueue) { sortableQueue.destroy(); sortableQueue = null; }
                return;
            }
            
            const itemsHtmlOnly = queueData.map((song, index) => {
                const addedBy = song.metadata?.addedBy;
                return `
                    <div class="queue-item queue-item-list" data-actual-queue-index="${index}" data-song-id="${song.id || 'qID'+index}"> 
                        ${currentUser ? '<span class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-lines"></i></span>' : ''}
                        <div class="song-info" style="font-weight: 400;">${song.name}
                            <div class="song-duration"><i class="fas fa-clock"></i> ${song.isLive ? 'LIVE' : formatDuration(song.duration)}</div>
                            ${addedBy ? `<small class="added-by"><img src="${addedBy.avatar || ''}" class="added-by-avatar" alt="${addedBy.name || ''}"><span style="font-weight: 300;">${addedBy.name || 'Unknown'}</span></small>` : ''}
                        </div>
                        ${currentUser ? `<button class="delete-btn" onclick="removeFromQueue(${index})"><i class="fas fa-trash"></i></button>` : ''}
                    </div>`;
            }).join('');
            
            queueItemsContainer.innerHTML = `
                <div class="queue-header"><strong style="font-weight: 600;"><i class="fas fa-headphones"></i> Up Next :</strong></div>
                <div id="sortable-items-actual">${itemsHtmlOnly}</div>
            `;

            const sortableElement = document.getElementById('sortable-items-actual');
            if (currentUser && sortableElement && queueData.length > 1) {
                if (sortableQueue) sortableQueue.destroy(); 
                sortableQueue = new Sortable(sortableElement, { 
                    animation: 150, handle: '.drag-handle', 
                    onEnd: (evt) => {
                        if (evt.oldIndex !== evt.newIndex) handleApiAction('/reorder-queue', 'POST', { oldIndex: evt.oldIndex, newIndex: evt.newIndex });
                    }
                });
            } else if (sortableQueue) { 
                sortableQueue.destroy(); sortableQueue = null;
            }
        }
        
        function removeFromQueue(indexInUpcomingQueue) { 
            if (!currentUser) return; 
            handleApiAction('/remove', 'POST', { index: indexInUpcomingQueue });
        }
        function formatDuration(s) { 
            if(isNaN(s)||s<0)return'0:00';
            const m=Math.floor(s/60);
            const rs=Math.floor(s%60);
            return`${m}:${rs.toString().padStart(2,'0')}`; 
        }
    </script>
</body>
</html>